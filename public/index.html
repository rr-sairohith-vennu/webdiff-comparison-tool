<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI Comparison Tool</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #000000;
      background-image:
        radial-gradient(at 40% 20%, rgba(120, 119, 198, 0.15) 0px, transparent 50%),
        radial-gradient(at 80% 0%, rgba(120, 119, 198, 0.12) 0px, transparent 50%),
        radial-gradient(at 0% 50%, rgba(120, 119, 198, 0.08) 0px, transparent 50%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #f5f5f7;
      letter-spacing: -0.022em;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 60px;
      animation: fadeInDown 0.8s ease-out;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header h1 {
      font-size: 56px;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(90deg, #ffffff 0%, #b8b8b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.05em;
    }

    .header p {
      font-size: 21px;
      color: #86868b;
      font-weight: 400;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.4;
    }

    .card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 24px;
      padding: 48px;
      margin-bottom: 24px;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.03),
        0 20px 80px rgba(0, 0, 0, 0.4);
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-group {
      margin-bottom: 28px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 12px;
      color: #f5f5f7;
      font-size: 15px;
      letter-spacing: -0.01em;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      font-size: 15px;
      color: #f5f5f7;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input[type="text"]::placeholder,
    textarea::placeholder {
      color: #86868b;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
    }

    textarea {
      resize: vertical;
      min-height: 90px;
    }

    .url-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .btn {
      background: #f5f5f7;
      color: #000000;
      border: none;
      padding: 16px 32px;
      font-size: 17px;
      font-weight: 500;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      letter-spacing: -0.01em;
      font-family: 'Inter', sans-serif;
    }

    .btn:hover {
      background: #ffffff;
      transform: scale(1.01);
      box-shadow: 0 8px 24px rgba(245, 245, 247, 0.2);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .advanced-toggle {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 14px 20px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 24px 0;
    }

    .advanced-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .advanced-toggle span {
      font-weight: 500;
      font-size: 15px;
      color: #f5f5f7;
    }

    .advanced-toggle .arrow {
      transition: transform 0.3s ease;
      font-size: 18px;
    }

    .advanced-toggle.active .arrow {
      transform: rotate(180deg);
    }

    .advanced-content {
      display: none;
      overflow: hidden;
      margin-top: -12px;
    }

    .advanced-content.active {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading {
      display: none;
      padding: 40px 20px;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .simple-loading-container {
      text-align: center;
      max-width: 500px;
      margin: 0 auto;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(99, 102, 241, 0.1);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 30px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .simple-loading-container h2 {
      font-size: 28px;
      font-weight: 600;
      color: #f5f5f7;
      margin: 0 0 12px 0;
    }

    .loading-message {
      font-size: 16px;
      color: #9ca3af;
      margin: 0 0 30px 0;
    }

    .simple-progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .simple-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6366f1, #a855f7);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Animated Progress Bar */
    .animated-progress-bar {
      width: 100%;
      max-width: 600px;
      height: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
      margin: 0 auto;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6366f1, #a855f7);
      border-radius: 4px;
      transition: width 0.3s ease;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
    }

    .results {
      display: none;
    }

    .results.active {
      display: block;
    }

    .results h3 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #f5f5f7;
      letter-spacing: -0.03em;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 48px;
    }

    .summary-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 32px 28px;
      border-radius: 18px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .summary-card:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateY(-2px);
    }

    .summary-card h3 {
      font-size: 48px;
      margin-bottom: 8px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .summary-card p {
      color: #86868b;
      font-size: 15px;
      font-weight: 500;
      margin: 0;
    }

    .screenshots {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 48px;
      position: relative;
    }

    .screenshot-container {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .screenshot-container:hover {
      border-color: rgba(255, 255, 255, 0.15);
    }

    .screenshot-container h3 {
      background: rgba(255, 255, 255, 0.03);
      padding: 18px 24px;
      margin: 0;
      font-size: 17px;
      font-weight: 500;
      color: #f5f5f7;
      letter-spacing: -0.01em;
    }

    .screenshot-container img {
      width: 100%;
      display: block;
    }

    .differences-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 24px;
    }

    .differences-table th,
    .differences-table td {
      padding: 18px 20px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .differences-table th {
      background: rgba(255, 255, 255, 0.03);
      font-weight: 500;
      color: #86868b;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .differences-table td {
      color: #f5f5f7;
      font-size: 15px;
    }

    .differences-table tbody tr {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .differences-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    .badge-high {
      background: rgba(255, 69, 58, 0.15);
      color: #ff453a;
      border: 1px solid rgba(255, 69, 58, 0.2);
    }

    .badge-medium {
      background: rgba(255, 159, 10, 0.15);
      color: #ff9f0a;
      border: 1px solid rgba(255, 159, 10, 0.2);
    }

    .badge-low {
      background: rgba(10, 132, 255, 0.15);
      color: #0a84ff;
      border: 1px solid rgba(10, 132, 255, 0.2);
    }

    .badge-content {
      background: rgba(100, 210, 255, 0.15);
      color: #64d2ff;
      border: 1px solid rgba(100, 210, 255, 0.2);
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #f5f5f7;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .url-row,
      .screenshots {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 40px;
      }

      .header p {
        font-size: 18px;
      }

      .card {
        padding: 32px 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Visual Comparison</h1>
      <p>Compare Production vs Preview. Instantly.</p>
    </div>

    <div class="card">
      <form id="comparisonForm">
        <div class="url-row">
          <div class="form-group">
            <label for="url1">üîó URL 1 (Production)</label>
            <input
              type="text"
              id="url1"
              name="url1"
              placeholder=""
              required
            />
          </div>

          <div class="form-group">
            <label for="url2">üîó URL 2 (Preview/Staging)</label>
            <input
              type="text"
              id="url2"
              name="url2"
              placeholder=""
              required
            />
          </div>
        </div>

        <!-- Advanced Settings Toggle -->
        <div class="advanced-toggle" id="advancedToggle">
          <span>‚öôÔ∏è Advanced Settings</span>
          <span class="arrow">‚ñº</span>
        </div>

        <!-- Advanced Settings Content (Hidden by default) -->
        <div class="advanced-content" id="advancedContent">
          <div class="form-group">
            <label for="clickAction">üñ±Ô∏è Click Actions (Optional)</label>
            <input
              type="text"
              id="clickAction"
              name="clickAction"
              placeholder="e.g., All, Confirmed, Pending, Payments"
            />
            <small style="display: block; margin-top: 8px; color: #86868b; font-size: 13px;">
              Enter button text or CSS selector. Use commas to compare multiple states
            </small>
          </div>

          <div class="form-group">
            <label for="cookies">üç™ Session Cookies (Optional - for authenticated pages)</label>
            <textarea
              id="cookies"
              name="cookies"
              placeholder='Paste cookies as JSON array, e.g.: [{"name":"RakutenToken","value":"abc123","domain":".rakuten.com"}]'
              style="font-family: 'Monaco', 'Courier New', monospace; font-size: 12px;"
            ></textarea>
            <small style="display: block; margin-top: 8px; color: #86868b; font-size: 13px;">
              üí° <strong>For Rakuten QA1/Preview URLs:</strong> Open DevTools (F12) ‚Üí Application ‚Üí Cookies ‚Üí Copy as JSON
            </small>
          </div>
        </div>

        <button type="submit" class="btn" id="compareBtn">
          üöÄ Compare Now
        </button>
      </form>
    </div>

    <div class="loading" id="loading">
      <div class="simple-loading-container">
        <div class="loading-spinner"></div>
        <h2>Comparing Pages...</h2>
        <p class="loading-message" id="loadingMessage">Please wait</p>
        <div class="simple-progress-bar">
          <div class="simple-progress-fill" id="simpleProgressFill"></div>
        </div>
        <div class="progress-text">
          <span id="simpleProgressPercent">0</span>%
        </div>
      </div>
    </div>

    <div class="results" id="results">
      <div class="card">
        <h2>üìä Comparison Results</h2>

        <div class="summary-grid">
          <div class="summary-card">
            <h3 id="totalDiffs">0</h3>
            <p>Total Differences</p>
          </div>
          <div class="summary-card">
            <h3 id="highSeverity">0</h3>
            <p>High Priority</p>
          </div>
          <div class="summary-card">
            <h3 id="mediumSeverity">0</h3>
            <p>Medium Priority</p>
          </div>
          <div class="summary-card">
            <h3 id="lowSeverity">0</h3>
            <p>Low Priority</p>
          </div>
        </div>

        <div id="comparisonsContainer"></div>

        <div style="margin-top: 30px; text-align: center; display: flex; gap: 15px; justify-content: center;">
          <button class="btn" onclick="generateShareReport()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üì§ Share Report</button>
          <button class="btn" onclick="location.reload()">üîÑ New Comparison</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Connect to Socket.IO for real-time updates
    const socket = io();

    let currentProgress = 0;
    let lastComparisonResult = null;

    // Advanced Settings Toggle
    document.getElementById('advancedToggle').addEventListener('click', function() {
      const content = document.getElementById('advancedContent');
      const toggle = document.getElementById('advancedToggle');

      content.classList.toggle('active');
      toggle.classList.toggle('active');
    });

    socket.on('progress', (data) => {
      console.log('Progress update:', data);
      if (data.step && data.detail) {
        const progressPercent = document.getElementById('simpleProgressPercent');
        const progressFill = document.getElementById('simpleProgressFill');
        const loadingMessage = document.getElementById('loadingMessage');

        // Map steps to progress percentages
        const stepProgressMap = {
          1: 15,   // Loading page 1
          2: 30,   // Loading page 2
          3: 45,   // Clicking buttons
          4: 65,   // Taking screenshots
          5: 80,   // Analyzing elements
          6: 95    // Drawing differences
        };

        currentProgress = stepProgressMap[data.step] || 0;

        if (progressPercent) {
          progressPercent.textContent = currentProgress;
        }

        if (progressFill) {
          progressFill.style.width = currentProgress + '%';
        }

        if (loadingMessage) {
          loadingMessage.textContent = data.detail;
        }
      }
    });

    document.getElementById('comparisonForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const url1 = document.getElementById('url1').value;
      const url2 = document.getElementById('url2').value;
      const clickAction = document.getElementById('clickAction').value.trim();
      const cookiesInput = document.getElementById('cookies').value.trim();

      // Parse cookies if provided
      let cookies = null;
      if (cookiesInput) {
        try {
          cookies = JSON.parse(cookiesInput);
        } catch (err) {
          alert('Invalid cookies format. Please provide a valid JSON array.');
          return;
        }
      }

      document.getElementById('loading').classList.add('active');
      document.getElementById('results').classList.remove('active');
      document.getElementById('compareBtn').disabled = true;

      try {
        const response = await fetch('/api/compare', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url1, url2, clickAction: clickAction || null, cookies })
        });

        const data = await response.json();

        if (data.success) {
          // Update to 100% complete
          const progressPercent = document.getElementById('simpleProgressPercent');
          const progressFill = document.getElementById('simpleProgressFill');
          const loadingMessage = document.getElementById('loadingMessage');

          if (progressPercent) progressPercent.textContent = '100';
          if (progressFill) progressFill.style.width = '100%';
          if (loadingMessage) loadingMessage.textContent = '‚úÖ Comparison complete!';

          setTimeout(() => {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('results').classList.add('active');
            displayResults(data.result);
          }, 500);
        } else {
          // Better error message formatting
          const errorMsg = data.error || 'An error occurred during comparison';
          alert('‚ö†Ô∏è ' + errorMsg);
          document.getElementById('loading').classList.remove('active');
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
        document.getElementById('loading').classList.remove('active');
      } finally {
        document.getElementById('compareBtn').disabled = false;
      }
    });

    function displayResults(result) {
      // Store the result for sharing
      lastComparisonResult = result;

      // Handle both single comparison and multiple comparisons
      const comparisons = result.comparisons || [result];

      // Calculate total stats across all comparisons
      let totalDiffs = 0, highCount = 0, mediumCount = 0, lowCount = 0;
      comparisons.forEach(comp => {
        totalDiffs += comp.differences.length;
        highCount += comp.summary.bySeverity.high || 0;
        mediumCount += comp.summary.bySeverity.medium || 0;
        lowCount += comp.summary.bySeverity.low || 0;
      });

      document.getElementById('totalDiffs').textContent = totalDiffs;
      document.getElementById('highSeverity').textContent = highCount;
      document.getElementById('mediumSeverity').textContent = mediumCount;
      document.getElementById('lowSeverity').textContent = lowCount;

      const container = document.getElementById('comparisonsContainer');
      container.innerHTML = '';

      // Display each comparison as a separate section
      comparisons.forEach((comp, index) => {
        const section = document.createElement('div');
        section.style.marginBottom = '48px';

        const buttonLabel = comp.clickedButton || 'Default View';

        section.innerHTML = `
          <h3 style="font-size: 24px; margin-bottom: 24px;">
            üñ±Ô∏è ${buttonLabel}
          </h3>

          <div class="screenshots" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 48px;">
            <div class="screenshot-container">
              <h3>URL 1 (Production)</h3>
              <img src="/${comp.screenshots.highlighted?.url1 || comp.screenshots.url1}" alt="URL 1 Screenshot" />
            </div>
            <div class="screenshot-container">
              <h3>URL 2 (Preview)</h3>
              <img src="/${comp.screenshots.highlighted?.url2 || comp.screenshots.url2}" alt="URL 2 Screenshot" />
            </div>
          </div>

          <h3 style="font-size: 20px; margin-bottom: 16px;">üîç Detailed Differences (${comp.differences.length})</h3>
          <table class="differences-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Category</th>
                <th>Severity</th>
                <th>URL 1 Value</th>
                <th>URL 2 Value</th>
              </tr>
            </thead>
            <tbody>
              ${comp.differences.length === 0 ?
                '<tr><td colspan="5" style="text-align: center; padding: 40px;">‚úÖ No differences found!</td></tr>' :
                comp.differences.map(diff => {
                  const truncate = (str, len = 100) => {
                    if (!str || str === 'Not present') return str;
                    return str.length > len ? str.substring(0, len) + '...' : str;
                  };

                  return `
                    <tr>
                      <td><span class="badge badge-${diff.type.toLowerCase()}">${diff.type}</span></td>
                      <td><strong>${diff.category}</strong></td>
                      <td><span class="badge badge-${diff.severity}">${diff.severity}</span></td>
                      <td style="max-width: 250px; word-break: break-word; font-size: 13px;">
                        ${truncate(diff.url1Value)}
                      </td>
                      <td style="max-width: 250px; word-break: break-word; font-size: 13px;">
                        ${truncate(diff.url2Value)}
                      </td>
                    </tr>
                  `;
                }).join('')
              }
            </tbody>
          </table>
        `;

        container.appendChild(section);
      });

      document.getElementById('results').classList.add('active');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    function generateShareReport() {
      if (!lastComparisonResult) {
        alert('No comparison results available to share!');
        return;
      }

      const comparisons = lastComparisonResult.comparisons || [lastComparisonResult];
      const url1 = document.getElementById('url1').value;
      const url2 = document.getElementById('url2').value;

      // Build HTML report
      let report = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UI Comparison Report</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px; background: #f5f5f7; color: #1d1d1f; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
    .header h1 { margin: 0 0 10px 0; font-size: 32px; }
    .urls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .url-row { margin: 10px 0; }
    .url-label { font-weight: 600; color: #667eea; }
    .url-value { color: #666; word-break: break-all; font-size: 14px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .stat-card h3 { font-size: 36px; margin: 0 0 10px 0; }
    .stat-card p { margin: 0; color: #666; font-size: 14px; }
    .comparison { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .comparison h2 { margin: 0 0 20px 0; color: #1d1d1f; font-size: 24px; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f5f5f7; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .badge-high { background: #ffe5e5; color: #d32f2f; }
    .badge-medium { background: #fff4e5; color: #f57c00; }
    .badge-low { background: #e8f5e9; color: #388e3c; }
    .badge-added { background: #e8f5e9; color: #2e7d32; }
    .badge-removed { background: #ffebee; color: #c62828; }
    .badge-modified { background: #fff3e0; color: #ef6c00; }
    .footer { text-align: center; color: #666; margin-top: 40px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä UI Comparison Report</h1>
    <p>Generated on ${new Date().toLocaleString()}</p>
  </div>

  <div class="urls">
    <div class="url-row">
      <div class="url-label">üîµ Production URL:</div>
      <div class="url-value">${url1}</div>
    </div>
    <div class="url-row">
      <div class="url-label">üü£ Preview/QA URL:</div>
      <div class="url-value">${url2}</div>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3>${document.getElementById('totalDiffs').textContent}</h3>
      <p>Total Differences</p>
    </div>
    <div class="stat-card">
      <h3 style="color: #d32f2f;">${document.getElementById('highSeverity').textContent}</h3>
      <p>High Priority</p>
    </div>
    <div class="stat-card">
      <h3 style="color: #f57c00;">${document.getElementById('mediumSeverity').textContent}</h3>
      <p>Medium Priority</p>
    </div>
    <div class="stat-card">
      <h3 style="color: #388e3c;">${document.getElementById('lowSeverity').textContent}</h3>
      <p>Low Priority</p>
    </div>
  </div>
`;

      // Add each comparison section
      comparisons.forEach(comp => {
        const clickAction = comp.clickAction ? ` - ${comp.clickAction}` : '';
        report += `
  <div class="comparison">
    <h2>üîç Comparison${clickAction}</h2>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Category</th>
          <th>Severity</th>
          <th>Production Value</th>
          <th>Preview Value</th>
        </tr>
      </thead>
      <tbody>
`;

        if (comp.differences && comp.differences.length > 0) {
          comp.differences.forEach(diff => {
            const truncate = (text) => text && text.length > 100 ? text.substring(0, 100) + '...' : (text || 'N/A');
            report += `
        <tr>
          <td><span class="badge badge-${diff.type.toLowerCase()}">${diff.type}</span></td>
          <td><strong>${diff.category}</strong></td>
          <td><span class="badge badge-${diff.severity}">${diff.severity}</span></td>
          <td>${truncate(diff.url1Value)}</td>
          <td>${truncate(diff.url2Value)}</td>
        </tr>
`;
          });
        } else {
          report += `
        <tr>
          <td colspan="5" style="text-align: center; color: #4caf50; font-weight: 600;">‚úÖ No differences found</td>
        </tr>
`;
        }

        report += `
      </tbody>
    </table>
  </div>
`;
      });

      report += `
  <div class="footer">
    <p>Generated by UI Comparison Tool</p>
    <p>Powered by Playwright + Node.js</p>
  </div>
</body>
</html>`;

      // Create and download the report
      const blob = new Blob([report], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ui-comparison-report-${Date.now()}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('‚úÖ Share report downloaded! You can open and share the HTML file.');
    }
  </script>
</body>
</html>
